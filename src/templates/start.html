<!doctype html>
<html lang="en">
<head>
<link rel="icon" href="/favicon.ico">
<link rel="stylesheet" type="text/css" href="/static/style.css">
<meta charset="utf-8">
<script src="/static/code.js"></script>
<script src="https://www.google.com/recaptcha/api.js"></script>
<style>
#intAmount,#intMinAmount {
	width: 6em;
}
#errorContainer {
	border: 5px solid red;
	color: red;
	margin: 1em;
	padding: 1em;
}
#successContainer {
	border: 5px solid green;
	margin: 1em;
	padding: 1em;
}
</style>
<title>Donation Swap</title>
</head>
<body>
{%FILE=header.snippet.html%}
	<div class="body">
		<div id="form">
			<p>
				<label for="txtName">My name is</label>
				<input autofocus class="bordered" id="txtName" placeholder="Preferred Name">.
			</p>
			<p>
				<label for="idCountry">I pay taxes in</label>
				<select class="bordered" id="idCountry"></select>
			</p>
			<p>
				<label for="intAmount">and I would like to donate</label>
				<input class="bordered" id="intAmount" min="0" type="number" value="100">
				<span id="txtCurrency1">$</span>
			</p>
			<p>
				<label for="idCharity">to</label>
				<select class="bordered" id="idCharity"></select>.
			</p>
			<p>
				<label for="chkTaxes"><input id="chkTaxes" type="checkbox">Show only tax-deductible charities</label>
			</p>
			<p>
				<a href="/charities/" target="_blank">Learn more</a> about our list of supported charities.
			</p>
			<p>
				<label for="intMinAmount">The smallest match I'm willing to agree to is</label>
				<input class="bordered" id="intMinAmount" type="number">
				<span id="txtCurrency2">$</span>.
			</p>
			<p>
				This offer is valid until
				<span class="bordered">
					<select id="intExpirationDay"></select>
					<select id="intExpirationMonth"></select>
					<select id="intExpirationYear"></select>
				</span>
			</p>
			<p>
				My Email Address is
				<input class="bordered" id="txtEmail" type="email">
			</p>
			{%FILE=captcha.snippet.html%}
			<div class="hidden" id="errorContainer">
				<p>An error has occurred:</p>
				<p id="errorText"></p>
			</div>
			<p>
				<button class="purple" id="btnSend">Submit</button>
			</p>
		</div>
		<div class="hidden" id="successContainer">
			<p>Thank you.</p>
			<p>
				We have sent you an email with a confirmation link.
				Please open that link to activate your offer and verify your email address.
			</p>
			<p>It is safe to close this tab.</p>
		</div>
	</div>
{%FILE=footer.snippet.html%}
<script>
/* globals ajax, createNode, getElementsById */
/* jshint esversion: 6 */

function captchaGood() {
	document.getElementById('btnSend').removeAttribute('disabled');
}

function captchaBad() {
	document.getElementById('btnSend').setAttribute('disabled', 'disabled');
}

(function () {
	'use strict';

	const ui = getElementsById();

	captchaBad();

	function populateCountries(countries) {
		countries.forEach(country => {
			ui.idCountry.appendChild(createNode({
				xtype: 'option',
				a_value: country.id,
				p_textContent: country.live_in_name,
			}));
		});
	}

	function populateCharities(charities, charitiesInCountry) {
		const categories = [... new Set(charities.map(charity => charity.category))];
		const categoryByName = {};
		const optgroups = [];

		categories.forEach(category => {
			optgroups.push(categoryByName[category] = createNode({
				xtype: 'optgroup',
				a_label: category,
			}));
		});

		charities.forEach(charity => {
			if (charitiesInCountry.length === 0 || charitiesInCountry.indexOf(charity.id) !== -1) {
				categoryByName[charity.category].appendChild(createNode({
					xtype: 'option',
					a_value: charity.id,
					p_textContent: charity.name,
				}));
			}
		});

		ui.idCharity.innerHTML = '';
		optgroups.forEach(optgroup => {
			if (optgroup.children.length > 0) {
				ui.idCharity.appendChild(optgroup);
			}
		});
	}

	ajax('/ajax/get_info')
		.then(info => {
			let args = {};
			try {
				args = JSON.parse(decodeURIComponent(window.location.hash.substr(1)));
			}
			catch(e) {
				// console.error(e);
			}

			const currencyByCountry = {};
			info.countries.forEach(country => {
				currencyByCountry[country.id] = {
					iso: country.currency_iso,
					name: country.currency_name,
				};
			});

			populateCountries(info.countries);
			ui.idCountry.value = args.hasOwnProperty('country') ? args.country : info.client_country;

			// handle country changes
			ui.idCountry.onchange = () => {
				const currency = currencyByCountry[ui.idCountry.value];
				//xxx ui.intAmount.setAttribute('min', 'xxx')
				ui.txtCurrency1.textContent = currency.iso;
				ui.txtCurrency1.setAttribute('title', currency.name);
				ui.txtCurrency2.textContent = currency.iso;
				ui.txtCurrency2.setAttribute('title', currency.name);

				populateCharities(info.charities, ui.chkTaxes.checked ? info.charities_in_countries[ui.idCountry.value] : []);
			};
			ui.idCountry.onchange(); // to set currency

			// populate amount
			ui.intAmount.value = args.hasOwnProperty('amount') ? args.amount : 50;
			ui.intMinAmount.value = args.hasOwnProperty('min_amount') ? args.min_amount : 50;

			populateCharities(info.charities, ui.chkTaxes.checked ? info.charities_in_countries[ui.idCountry.value] : []);
			if (args.hasOwnProperty('charity')) {
				ui.idCharity.value = args.charity;
			}

			ui.chkTaxes.onchange = () => {
				populateCharities(info.charities, ui.chkTaxes.checked ? info.charities_in_countries[ui.idCountry.value] : []);
			};

			// populate calendar
			for (let day = 1; day <= 31; day++) {
				ui.intExpirationDay.appendChild(createNode({
					xtype: 'option',
					a_value: day,
					p_textContent: `${('0' + day).substr(-2)}.`,
				}));
			}
			const monthNames = [null,
				'January', 'February', 'March', 'April',
				'May', 'June', 'July', 'August',
				'September', 'October', 'November', 'December'];
			for (let month = 1; month <= 12; month++) {
				ui.intExpirationMonth.appendChild(createNode({
					xtype: 'option',
					a_value: month,
					p_textContent: monthNames[month],
				}));
			}
			for (let year = info.today.year; year <= info.today.year + 2; year++) {
				ui.intExpirationYear.appendChild(createNode({
					xtype: 'option',
					a_value: year,
					p_textContent: year,
				}));
			}
			ui.intExpirationDay.value = (args.expires || [])[0] || info.today.day;
			ui.intExpirationMonth.value = (args.expires || [])[1] || info.today.month;
			ui.intExpirationYear.value = (args.expires || [])[2] || info.today.year + 1;
			ui.txtEmail.value = args.email || '';

			// handle form submission
			ui.btnSend.onclick = () => {
				//xxx client-side validation
				captchaBad(); // disable send button
				ajax('/ajax/create_offer', {
					captcha_response: document.getElementsByName('g-recaptcha-response')[0].value,
					name: ui.txtName.value,
					country: parseInt(ui.idCountry.value, 10),
					amount: parseInt(ui.intAmount.value, 10),
					min_amount: parseInt(ui.intMinAmount.value, 10),
					charity: parseInt(ui.idCharity.value, 10),
					email: ui.txtEmail.value,
				expiration: {
						day: ui.intExpirationDay.value,
						month: ui.intExpirationMonth.value,
						year: ui.intExpirationYear.value,
					},
				})
				.then(() => {
					ui.successContainer.classList.remove('hidden');
					ui.form.classList.add('hidden');
				})
				.catch(error => {
					ui.errorText.textContent = error || '<unknown error>';
					ui.errorContainer.classList.remove('hidden');
					captchaGood(); // enable send button
				});
			};
		});
}());
</script>
</body>
</html>
