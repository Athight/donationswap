<!doctype html>
<html>
<head>
<link rel="icon" href="/favicon.ico">
<link rel="stylesheet" type="text/css" href="/static/style.css">
<meta charset="utf-8">
<script src="/static/code.js"></script>
<title>Donation Swap</title>
</head>
<body>
{%FILE=header.snippet.html%}
<h1>Your Offer</h1>
	<tbody>
		<tr>
			<td>Amount:</td>
			<td><span id="currency"></span> <span id="amount"></span></td>
		</tr>
		<tr>
			<td>Charity:</td>
			<td><span id="charity"></span></td>
		</tr>
		<tr>
			<td>Created:</td>
			<td><span id="creationDate"></span></td>
		</tr>
		<tr>
			<td>Expires:</td>
			<td><span id="expirationDate"></span></td>
		</tr>
	</tbody>
</table>
<p class="hidden" id="confirmed">Thank you for activating your offer.</p>
<p>We will send you an email when we find a match. You can create another post <a href="/">here</a>.</p>
<table class="hidden" id="table">
<button class="hidden" id="btnDelete">Delete</button>
<div id="message">Loading...</div>
{%FILE=footer.snippet.html%}
<script>
/* globals ajax, getElementsById */
/* jshint esversion: 6 */
(function () {
	'use strict';

	const ui = getElementsById();
	const secret = window.location.hash.substr(1);

	function setVisibility(offer) {
		ui.table.classList.toggle('hidden', !offer);
		ui.btnDelete.classList.toggle('hidden', !offer);
		ui.message.classList.toggle('hidden', !ui.message.textContent);
	}

	function handleError() {
		ui.message.innerHTML = '<p>Something went wrong.</p><p>We\'re probably already working on it, but if this happens a lot, feel free to <a href="/contact">let us know</a>.</p>';
		setVisibility(null);
	}

	ajax('confirm_offer', { secret })
		.then(offer => {
			if (offer) {
				ui.confirmed.classList.toggle('hidden', offer.was_confirmed);
				ui.currency.textContent = offer.currency;
				ui.amount.textContent = offer.amount;
				ui.charity.textContent = offer.charity;
				ui.creationDate.textContent = Date.fromUtcIsoString(offer.created_ts).toLocalString('%Y-%m-%d %H:%M');
				ui.expirationDate.textContent = Date.fromUtcIsoString(offer.expires_ts).toLocalString('%Y-%m-%d %H:%M');
				ui.message.textContent = '';
			} else {
				ui.message.innerHTML = '<p>The requested post could not be found.</p><p>Maybe it was deleted or expired?</p><p>You can create a new one <a href="/">here</a>.</p>';
			}
			setVisibility(offer);
		})
		.catch(handleError);

	ui.btnDelete.onclick = () => {
		if (confirm('Do you want to delete this offer?')) {
			ajax('delete_offer', { secret })
				.then(response => {
					ui.message.innerHTML = '<p>The offer has been deleted. Click <a href="/">here</a> to create a new one.</p>';
					setVisibility(null);
				})
				.catch(handleError);
		}
	};
}());
</script>
</body>
</html>
